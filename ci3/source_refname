# Set REF_NAME to be the branch name if on a branch, or the tag name if on a tag.
# If REF_NAME starts with "release/", just keep what comes after.
# Example outputs:
# - master (branch is master)
# - cl/ci_branch (a feature branch)
# - v1.2.3 (a tagged version)
# - wise-weasle (a tagged release e.g. release/wise-weasle)
# We use this for e.g:
# - Creating a unique instance name when launching spots.
# - Identifying GitHub releases to upload assets to.
# - Tagging released images.
# - Identifying a PR associated with a branch.
# This is obviously overloaded in terms of how its value is generated, and how it's used.
# So far this has been fine, so requiring more distinct variables has been unnecessary.
# In Github Actions we need to take from what GA provides to avoid any race conditions.
if [ -n "${GITHUB_REF:-}" ]; then
  REF_NAME="${GITHUB_REF#refs/heads/}"   # Extract branch name
  REF_NAME="${REF_NAME#refs/tags/}"      # Extract tag name
  REF_NAME="${REF_NAME#refs/pull/}"      # Handle PRs
else
  if [ -z "${REF_NAME:-}" ]; then
    export REF_NAME=$(git symbolic-ref --short -q HEAD || git describe --tags --exact-match)
    [ -z "${REF_NAME:-}" ] && exit 1
  fi
fi
export REF_NAME="${REF_NAME#release/}"

[ -z "${COMMIT_HASH:-}" ] && export COMMIT_HASH=$(git rev-parse HEAD)
