#!/bin/bash
NO_CD=1 source $(git rev-parse --show-toplevel)/ci3/source

# The entire command is in arg1. This splits it back out into positional args.
eval set -- "$1"

key=$(hash_str "$*")
# Discard the content hash.
shift

if [ "${USE_TEST_CACHE:-0}" -eq 1 ] && [ "$(redis-cli --raw -h $ci_redis EXISTS $key)" == "1" ]; then
  exit 0
fi

set +e
output=$(dump_fail "$*")
code=$?

if [ $? -ne 0 ]; then
  echo "$output"
elif [ "${USE_TEST_CACHE:-0}" -eq 1 ]; then
  {
    echo "Command: $*"
    echo "$output"
  } | redis-cli -h $ci_redis -x SETEX $key 604800 &>/dev/null
fi

exit $code