#!/bin/bash
NO_CD=1 source $(git rev-parse --show-toplevel)/ci3/source

cmd=$1
test_cmd="${cmd#* }"
key=$(hash_str "$cmd")

if [ "${USE_TEST_CACHE:-0}" -eq 1 ] && [ "$(redis-cli --raw -h $CI_REDIS EXISTS $key)" == "1" ]; then
  exit 0
fi

# If the test has a verbose mode, we want it enabled.
export VERBOSE=1

set +e
output=$(bash -c "$test_cmd" 2>&1)
code=$?

if [ -n "$CI_REDIS" ]; then
  # Set success flag for test. This key is unique to the test.
  redis-cli -h $CI_REDIS SETEX $key 604800 1 &>/dev/null
  # Set the test log. This key is globally unique.
  log_key=$(uuid)
  echo "$output" | redis-cli -h $CI_REDIS -x SETEX $log_key 604800 &>/dev/null
  log_info=" ${yellow}$log_key${reset}"
fi

if [ $code -eq 0 ]; then
  echo -e "${green}PASSED${reset}${log_info:-}: $test_cmd"
else
  echo -e "${red}FAILED${reset}${log_info:-}: $test_cmd (code: $code)"
  echo "$output"
  echo -e "${red}FAILED${reset}${log_info:-}: $test_cmd (code: $code)"
fi

exit $code