# Source this first in all bootstrap scripts.
# Usage: source $(git rev-parse --show-toplevel)/ci3/source_bootstrap
source $(git rev-parse --show-toplevel)/ci3/source

case "${1:-}" in
  "ci")
    # Forces yarn immutability, jest snapshot immutability, etc.
    export CI=1
    # Being in CI implies use of cache, and enables denoising.
    export USE_CACHE=${USE_CACHE:-1}
    export DENOISE=${DENOISE:-1}
    ;;
  ""|"fast")
    export USE_CACHE=${USE_CACHE:-1}
    ;;
esac

# Filters any test cmd that matches any pattern in the repos root .test_skip_patterns file.
# We filter comment lines and blank lines from the pattern file.
# Then filter through cache to remove previously successfully run tests.
function filter_test_cmds {
  grep -Ev -f <(grep -Ev -e '^\s*$' -e '^\s*#' $root/.test_skip_patterns) | filter_cached_test_cmd
}
