#!/bin/bash
# Use the minio script base. We ensure minio is running and wipe it.
source $(git rev-parse --show-toplevel)/ci3/cache/test_source

set -o pipefail

export DENOISE=${DENOISE:-1}
# Tests the various modes of bootstrap test usage.
# We wrap and mock ci3/cache/should_run to detect when a test tries to run.
# We never return true, as we don't actually want to run tests here.
# - First, with CI=0, we assert that should_run returns true to each test.
# - Then, with CI=1, we assert that should_run returns true to each test, as it is a first pass.
# - Next, with CI=1, we assert that should_run returns false to each test, as it is a second pass.
# We mock ci3/cache/should_run for this purpose.
function run_cleanup() {
  rm -f $ci3/cache/download.bkup
  rm -f $ci3/cache/should_run.bkup
  git checkout -- $ci3/cache/should_run
  git checkout -- $ci3/cache/download
}
function exit_cleanup() {
  run_cleanup
  rm -f $ci3/cache/.test_failures
}
trap exit_cleanup EXIT

function run_bootstrap() {
  set +e
  project=$1
  cp $ci3/cache/should_run $ci3/cache/should_run.bkup
  cp $ci3/cache/download $ci3/cache/download.bkup
  # Install our mocks
  cp $2 $ci3/cache/should_run
  cp $3 $ci3/cache/download
  rm -f $ci3/cache/.test_faillures

  cd $root/$project
  TEST=1 USE_CACHE=1 $ci3/base/denoise ./bootstrap.sh
  exit_code=$?
  if [ "$exit_code" != 0 ]; then
    echo "Bootstrap had a bad exit code $exit_code."
    all_tests_passed=false
    return 1
  fi
  run_cleanup
}

function check_for_bad_asserts() {
  if [ -s "$ci3/cache/.test_faillures" ]; then
    echo "Failures detected:"
    cat "$ci3/cache/.test_faillures"
    all_tests_passed=false
    return 1
  fi
}

# Initialize the overall test status
all_tests_passed=true

function test_CI_0() {
  CI=0 run_bootstrap $1 $root/scripts/tests/bootstrap/should_run_first_pass.sh $root/scripts/tests/bootstrap/download_first_pass.sh
  check_for_bad_asserts
}

function test_CI_1_first_pass() {
  CI=1 run_bootstrap $1 $root/scripts/tests/bootstrap/should_run_first_pass.sh $root/scripts/tests/bootstrap/download_first_pass.sh
  check_for_bad_asserts
}

function test_CI_1_second_pass() {
  CI=1 run_bootstrap $1 $root/scripts/tests/bootstrap/should_run_second_pass.sh $root/scripts/tests/bootstrap/download_second_pass.sh
  check_for_bad_asserts
}

PROJECTS=(
  noir
  barretenberg
  l1-contracts
  avm-transpiler
  noir-projects
  yarn-project
  boxes
)

for project in "${PROJECTS[@]}"; do
  # Run the tests
  echo "$project 1/3: CI=0 tests should run"
  test_CI_0 $project | sed "s/^/$project 1\/3: /" || (echo "$project 1/3 failure" && exit 1)
  echo "$project 1/3 success"
  echo "$project 2/3: CI=1 should_run should be true, tests should run, download should be false"
  test_CI_1_first_pass $project | sed "s/^/$project 2\/3: /" || (echo "$project 2/3 failure" && exit 1)
  echo "$project 2/3 success"
  echo "$project 3/3: CI=1 should_run should be false, download should be true"
  test_CI_1_second_pass $project | sed "s/^/$project 3\/3: /" || (echo "$project 3/3 failure" && exit 1)
  echo "$project 3/3 success"
done

echo "success: ./bootstrap.sh consistency tests have all passed."