#!/usr/bin/env bash
# Use ci3 script base.
source $(git rev-parse --show-toplevel)/ci3/base/source

CMD=${1:-}

if [ -n "$CMD" ]; then
  if [ "$CMD" = "clean" ]; then
    git clean -fdx
    exit 0
  else
    echo "Unknown command: $CMD"
    exit 1
  fi
fi
$ci3/github/group "noir-projects build"
# TODO: Remove yarn, use bash?
yarn install

CIRCUITS_HASH=$($ci3/cache/content_hash ../noir/.rebuild_patterns_native {noir-protocol-circuits,mock-protocol-circuits,noir-contracts}/.rebuild_patterns)
VKS_HASH=$($ci3/cache/content_hash ../noir/.rebuild_patterns_native {../barretenberg/cpp,noir-protocol-circuits,mock-protocol-circuits,noir-contracts}/.rebuild_patterns)

# Attempt to just pull artefacts from CI first.
if ! $ci3/cache/download noir-projects-circuits-$CIRCUITS_HASH.tar.gz; then
  parallel --joblog circuits.log --line-buffer --tag {} ::: \
    ./noir-contracts/bootstrap_circuits.sh \
    ./noir-protocol-circuits/bootstrap_circuits.sh \
    ./mock-protocol-circuits/bootstrap_circuits.sh
  $ci3/cache/upload noir-projects-circuits-$CIRCUITS_HASH.tar.gz {noir-contracts,noir-protocol-circuits,mock-protocol-circuits}/target noir-protocol-circuits/{Nargo.toml,private_kernel_reset_dimensions.json,crates/autogenerated}
fi

if ! $ci3/cache/download noir-projects-vks-$VKS_HASH.tar.gz; then
  parallel --joblog vks.log --line-buffer --tag {} ::: \
    ./noir-contracts/bootstrap_vks.sh \
    ./noir-protocol-circuits/bootstrap_vks.sh \
    ./mock-protocol-circuits/bootstrap_vks.sh
  $ci3/cache/upload noir-projects-vks-$VKS_HASH.tar.gz noir-contracts/target {noir-protocol-circuits,mock-protocol-circuits}/target/keys
fi
$ci3/github/endgroup

if $ci3/base/is_test && $ci3/cache/has_flag noir-projects-tests-$CIRCUITS_HASH; then
  $ci3/github/group "noir-projects test"
  NARGO=${NARGO:-../../noir/noir-repo/target/release/nargo}

  (cd ./noir-protocol-circuits && $NARGO fmt --check && $NARGO test --silence-warnings)
  (cd ./mock-protocol-circuits && $NARGO fmt --check)
  (cd ./noir-contracts && $NARGO fmt --check)
  (cd ./aztec-nr && $NARGO fmt --check)
  $ci3/cache/upload_flag noir-projects-tests-$CIRCUITS_HASH
  # Testing aztec.nr/contracts requires TXE, so must be pushed to after the final yarn project build.
  $ci3/github/endgroup
fi