VERSION 0.8

FROM ../build-images/+base-slim-node
WORKDIR /usr/src/docs

deps:
  RUN apt update && apt install -y jq curl perl && rm -rf /var/lib/apt/lists/* && apt-get clean
  COPY ./yarn.lock ./yarn.lock
  COPY ./package.json ./package.json
  RUN yarn install --frozen-lockfile

build:
  ARG ENV
  ARG COMMIT_TAG
  ENV COMMIT_TAG=$COMMIT_TAG
  BUILD ../yarn-project/+build-dev
  BUILD ../+release-meta
  FROM +deps
  COPY --dir ../yarn-project/+build-dev/usr/src /usr
  COPY ../+release-meta/usr/src/.release-please-manifest.json /usr/src
  COPY . .
  RUN ./scripts/build.sh
  SAVE ARTIFACT build

serve:
  ARG ENV
  FROM +deps
  COPY +build/build build
  COPY ./static static
  COPY ./src src
  COPY ./docusaurus.config.js .
  COPY ./playwright.config.ts .
  COPY ./sidebars.js .
  COPY ./docs docs
  ENTRYPOINT ["yarn", "serve"]
  EXPOSE 3000
  SAVE ARTIFACT /usr/src/docs
  SAVE IMAGE aztecprotocol/docs-server

serve-test:
  FROM earthly/dind:ubuntu-23.04-docker-25.0.2-1
  COPY --dir ../yarn-project/+build-dev/usr/src /usr
  COPY --dir +serve/ /usr/src
  COPY ../+release-meta/usr/src/.release-please-manifest.json /usr/src
  COPY +build/build build

  RUN PROFILE=~/.profile bash -c 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash'
  RUN . ~/.profile && nvm install node && npm i -g yarn

  SAVE ARTIFACT /usr/src/docs
  
test:
  FROM +serve-test
  COPY --dir ../yarn-project/+build-dev/usr/src /usr
  COPY ../+release-meta/usr/src/.release-please-manifest.json /usr/src
  
  WORKDIR /usr/src/docs
  COPY ../noir/+nargo/nargo /usr/local/bin/aztec-nargo
  RUN cp -s /usr/src/yarn-project/builder/aztec-builder-dest /usr/local/bin/aztec-builder

  RUN . ~/.profile && \
      yarn && \
      yarn add @playwright/test && \
      npx playwright install

  COPY docker-compose.yml .
  WITH DOCKER \
    --compose docker-compose.yml
    RUN docker-compose up -d && ls -la && yarn test
  END

deploy-preview:
  BUILD ../yarn-project/+scripts-prod
  ARG ENV
  ARG NETLIFY_AUTH_TOKEN
  ARG NETLIFY_SITE_ID
  ARG AZTEC_BOT_COMMENTER_GITHUB_TOKEN
  ARG PR
  FROM +serve
  COPY --dir ../yarn-project/+scripts-prod/usr/src/yarn-project /usr/src
  COPY ./netlify.toml .
  COPY ./deploy_preview.sh .
  RUN NETLIFY_AUTH_TOKEN=$NETLIFY_AUTH_TOKEN NETLIFY_SITE_ID=$NETLIFY_SITE_ID ./deploy_preview.sh $PR $AZTEC_BOT_COMMENTER_GITHUB_TOKEN

deploy-prod:
  BUILD ../yarn-project/+scripts-prod
  ARG NETLIFY_AUTH_TOKEN
  ARG NETLIFY_SITE_ID
  FROM +serve
  COPY ./netlify.toml .
  COPY ./deploy_prod.sh .
  RUN NETLIFY_AUTH_TOKEN=$NETLIFY_AUTH_TOKEN NETLIFY_SITE_ID=$NETLIFY_SITE_ID ./deploy_prod.sh
